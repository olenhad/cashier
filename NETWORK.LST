8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:23:50  11/08/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN NETWORK.OBJ
ASSEMBLER INVOKED BY:  F:\CASHIER\ASM86.EXE NETWORK.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   set_timer2:far
                            20     
----                        21     STACK_SEG       SEGMENT
0000 (256                   22                     DB      256 DUP(?)
     ??
     )
0100                        23             TOS     LABEL   WORD
----                        24     STACK_SEG       ENDS
                            25     
                            26     
----                        27     DATA_SEG        SEGMENT
0000 0A                     28             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
0016 2F                     29             T_COUNT         DB      2FH
0017 2F                     30             T_COUNT_SET     DB      2FH
0018 0A                     31             REC_MESS        DB      10,13,'Period of timer0 =     '
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
0031 0A                     32             BARCODE     DB  10,13,'18243337'
0032 0D
0033 31383234333333
     37
003B 0A                     33             RECV_MESS       DB      10,13,'PRICE RECV'
003C 0D
003D 50524943452052
     454356
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:23:50  11/08/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

0047 (8                     34             CUR_PRICE       DB      8 DUP(?)
     ??
     )
004F 00                     35             CUR_INDEX       DB      0
0050 00                     36             NET_STATE       DB      0
0051 61                     37             ADDRESS         DB      'a'
                            38             ;0 => READY
                            39             ;1 => SELECTED
                            40             ;2 => BUFFERING
                            41             
----                        42     DATA_SEG        ENDS
  0000                      43     NET_READY EQU 0
  0001                      44     NET_SELECTED EQU 1
  0002                      45     NET_BUFFERING EQU 2
                            46     
----                        47     CODE_SEG        SEGMENT
                            48     
                            49             PUBLIC          START
                            50     
                            51     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            52     
0000                        53     START:
                            54     ;initialize stack area
0000 B8----         R       55                     MOV     AX,STACK_SEG            
0003 8ED0                   56                     MOV     SS,AX
0005 368B260001             57                     MOV     SP,TOS
                            58     
                            59     ; Initialize the on-chip pheripherals
000A 9A0000----     E       60                     CALL    FAR PTR IODEFINE
                            61                     
                            62     
                            63     
                            64     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
000F 9A0000----     E       65         call set_timer2
0014 FB                     66                      STI
                            67     
0015                        68     NEXT:     
0015 EBFE                   69     JMP NEXT
                            70     
                            71     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                            72     
                            73     
0017                        74     SERIAL_REC_ACTION       PROC    FAR
0017 51                     75                     PUSH    CX
0018 53                     76                     PUSH    BX
0019 1E                     77                     PUSH    DS
                            78     
001A BB----         R       79                     MOV     BX,DATA_SEG             ;initialize data segment register
001D 8EDB                   80                     MOV     DS,BX
001F 8A1E5000               81                     MOV BL, DS:NET_STATE
0023 80FB02                 82                     CMP BL, NET_BUFFERING
0026 7431                   83                     JZ BUFFERING
0028 80FB01                 84                     CMP BL, NET_SELECTED
002B 7406                   85                     JZ SELECTED
                            86                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:23:50  11/08/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

002D 3A065100               87                     CMP     AL,DS:ADDRESS
0031 751E                   88                     JNE     WRONG_ADDRESS
                            89     ;               IF POLL IS SELECTING DS:ADDRESS, TRANSMIT THE BARCODE
0033                        90     SELECTED:
0033 C606500001             91                     MOV DS:NET_STATE, 01
0038 B90A00                 92                     MOV CX, 10
003B BB0000                 93                     MOV BX, 0
003E                        94     START_TRANSMIT:         
003E 8A4731                 95                     MOV AL,DS:BARCODE[BX]
0041 9A0000----     E       96                     CALL FAR PTR PRINT_CHAR
0046 43                     97                     INC BX
0047 E2F5                   98                     LOOP    START_TRANSMIT
0049 C606500002             99                     MOV DS:NET_STATE, NET_BUFFERING
004E EB3E90                100                     JMP     S_RET
                           101     
0051                       102     WRONG_ADDRESS:          
0051 9A0000----     E      103                     CALL FAR PTR PRINT_CHAR
0056 EB3690                104                     JMP S_RET
0059                       105     BUFFERING:
0059 8A1E4F00              106                     MOV BL, DS:CUR_INDEX
005D 32FF                  107                     XOR BH,BH
005F 884747                108                     MOV DS:CUR_PRICE[BX], AL
                           109                     
0062 FEC3                  110                     INC BL
0064 80FB08                111                     CMP BL, 08
0067 7D07                  112                     JGE BUFFER_END
0069 881E4F00              113                     MOV DS:CUR_INDEX, BL
006D EB1F90                114                     JMP S_RET
0070                       115     BUFFER_END:
0070 B90800                116                     MOV CX,08
0073 BB0000                117                     MOV BX, 0
0076 8A4747                118                     MOV AL, DS:CUR_PRICE[BX]
0079                       119     ACK_LOOP:
0079 8A4747                120                     MOV AL, DS:CUR_PRICE[BX]
007C 9A0000----     E      121                     CALL FAR PTR PRINT_CHAR
0081 43                    122                     INC BX
0082 E2F5                  123                     LOOP    ACK_LOOP
0084 C606500000            124                     MOV DS:NET_STATE, NET_READY
0089 32C0                  125                     XOR AL,AL
008B A24F00                126                     MOV DS:CUR_INDEX, AL
008E                       127     S_RET:
008E 1F                    128                     POP     DS
008F 5B                    129                     POP     BX
0090 59                    130                     POP     CX
0091 CB                    131                     RET
                           132     SERIAL_REC_ACTION       ENDP
                           133     
                           134     
                           135     
0092                       136     TIMER2_ACTION   PROC    FAR
0092 50                    137                     PUSH    AX
0093 1E                    138                     PUSH    DS
0094 53                    139                     PUSH    BX
0095 51                    140                     PUSH    CX
                           141     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:23:50  11/08/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

0096 B8----         R      142                     MOV     AX,DATA_SEG
0099 8ED8                  143                     MOV     DS,AX
                           144             
009B FE0E1600              145                     DEC     DS:T_COUNT
009F 7506                  146                     JNZ     T_NEXT1
00A1 A01700                147                     MOV     AL,DS:T_COUNT_SET
00A4 A21600                148                     MOV     DS:T_COUNT,AL
                           149     
                           150     ;               MOV     CX,20
                           151     ;               MOV     BX,0H
00A7                       152     T_NEXT0:
                           153     ;               MOV     AL,DS:TIMER0_MESS[BX]
                           154     ;               INC     BX
                           155     ;               CALL    FAR PTR PRINT_CHAR
                           156     ;               LOOP    T_NEXT0
                           157     
00A7                       158     T_NEXT1:
00A7 BA0001                159                     MOV DX, 0100H
00AA B80100                160                     MOV AX, 01H
00AD EF                    161                     OUT DX, AX
                           162                     
00AE BA8001                163                     MOV DX, 0180H
00B1 B87E00                164                     MOV AX, 07EH
00B4 EF                    165                     OUT DX, AX
                           166                     
00B5 59                    167                     POP     CX
00B6 5B                    168                     POP     BX
00B7 1F                    169                     POP     DS
00B8 58                    170                     POP     AX
00B9 CB                    171                     RET
                           172     TIMER2_ACTION   ENDP
                           173     
                           174     
----                       175     CODE_SEG        ENDS
                           176     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
