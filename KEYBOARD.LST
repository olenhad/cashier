8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    13:42:19  11/15/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN KEYBOARD.OBJ
ASSEMBLER INVOKED BY:  G:\CASHIER\ASM86.EXE KEYBOARD.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     ; 1 KEYBOARD VERSION (TESTING ONLY)
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   set_timer2:far
  0080                      20     PORTA   equ 080h
  0081                      21     PORTB EQU 081H
  0082                      22     PORTC EQU 082H
  0083                      23     CWR EQU 083H
                            24     
----                        25     STACK_SEG       SEGMENT
0000 (256                   26                     DB      256 DUP(?)
     ??
     )
0100                        27             TOS     LABEL   WORD
----                        28     STACK_SEG       ENDS
                            29     
                            30     
----                        31     DATA_SEG        SEGMENT
                            32             
0000 0A                     33             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
0016 2F                     34             T_COUNT         DB      2FH
0017 2F                     35             T_COUNT_SET     DB      2FH
0018 0A                     36             REC_MESS        DB      10,13,'Period of timer0 = '  
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D20
002D 31                     37             array       DB      '1','2','3','4','5','6','7','8','9','*','0','#'     
002E 32
002F 33
0030 34
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    13:42:19  11/15/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

0031 35
0032 36
0033 37
0034 38
0035 39
0036 2A
0037 30
0038 23
                            38     
                            39     ;=========================================================================
                            40     ;Port B of the 8255 is used as the input port for the keybad
                            41     ;Port C is used as the output and grounds the rows one by one
                            42     ;=========================================================================
                            43     
----                        44     DATA_SEG        ENDS
                            45     
                            46     
----                        47     CODE_SEG        SEGMENT
                            48     
                            49             PUBLIC          START
                            50     
                            51     ASSUME  CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                            52     
0000                        53     START:
                            54     ;initialize stack area
0000 B8----         R       55                     MOV     AX,STACK_SEG            
0003 8ED0                   56                     MOV     SS,AX
0005 368B260001             57                     MOV     SP,TOS
                            58     ;Initialise data segment
000A B8----         R       59                     MOV AX,DATA_SEG
000D 8ED8                   60                     MOV DS,AX
                            61     
                            62     ; Initialize the on-chip pheripherals
000F 9A0000----     E       63                     CALL FAR PTR IODEFINE
                            64                     
                            65     
                            66     
                            67     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                            68        
0014 B082                   69     MOV AL, 82H       ;mode 0, A - out, B-in ;changed value of CW from 82H
0016 BA8300                 70                     MOV DX, CWR
0019 EE                     71                     OUT DX, AL      ;send the control word
001A B300                   72                     MOV BL, 00H     ;initialize BL for key code
001C 33C0                   73                     XOR AX, AX      ;clear ax flags
001E BA8200                 74                     MOV DX, PORTC  ;port C address to DX
0021 EE                     75                     OUT DX, AL      ;ground all rows
                            76                     
                            77     
                            78     
                            79        
                            80     ;code
                            81      ;call set_timer2
0022 FB                     82                     STI
                            83     
0023                        84     NEXT: 
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    13:42:19  11/15/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

0023 9A6A00----     R       85     CALL FAR PTR KEYBOARD
0028 EBF9                   86      JMP NEXT
                            87     
                            88     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                            89     
                            90     
002A                        91     SERIAL_REC_ACTION       PROC    FAR
002A 51                     92                     PUSH    CX
002B 53                     93                     PUSH    BX
002C 1E                     94                     PUSH    DS
                            95     
002D BB----         R       96                     MOV     BX,DATA_SEG             ;initialize data segment register
0030 8EDB                   97                     MOV     DS,BX
                            98     
0032 3C3C                   99                     CMP     AL,'<'
0034 750B                  100                     JNE     S_FAST
                           101     
0036 FE061700              102                     INC     DS:T_COUNT_SET
003A FE061700              103                     INC     DS:T_COUNT_SET
                           104     
003E EB0D90                105                     JMP     S_NEXT0
0041                       106     S_FAST:
0041 3C3E                  107                     CMP     AL,'>'
0043 7521                  108                     JNE     S_RET
                           109     
0045 FE0E1700              110                     DEC     DS:T_COUNT_SET
0049 FE0E1700              111                     DEC     DS:T_COUNT_SET
                           112     
004D                       113     S_NEXT0:
004D B91600                114                     MOV     CX,22                   ;initialize counter for message
0050 BB0000                115                     MOV     BX,0
                           116     
0053 8A4718                117     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
0056 9A0000----     E      118                     call    FAR ptr print_char
005B 43                    119                     INC     BX
005C E2F5                  120                     LOOP    S_NEXT1
                           121     
005E A01700                122                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
0061 9A0000----     E      123                     CALL    FAR PTR PRINT_2HEX
0066                       124     S_RET:
0066 1F                    125                     POP     DS
0067 5B                    126                     POP     BX
0068 59                    127                     POP     CX
0069 CB                    128                     RET
                           129     SERIAL_REC_ACTION       ENDP
                           130     
006A                       131     KEYBOARD PROC FAR
                           132     
006A 52                    133                     PUSH    DX
006B 51                    134                     PUSH    CX
006C 53                    135                     PUSH    BX
006D 50                    136                     PUSH    AX
                           137                     
                           138     
006E                       139     INIT:           
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    13:42:19  11/15/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           140                     
                           141                     
006E B17F                  142                     MOV CL, 07FH    ;STORES OUTPUT FOR ROW COUNTER;
                           143                     ;MOV AL,0FEH ; 1111 1110
0070 B500                  144                     MOV CH, 0H      ;set row counter
                           145                     
                           146     
                           147                     
0072                       148     NXTROW:         
0072 D0C1                  149                     ROL CL, 01H       ;rotate AL to ground next row/ al HAS 8 BITS. so mu
                                   st JMP BACK TO WAIT
                           150     
                           151                     ;MOV CH, AL     ;save data byte to ground next row ;WAT?
0074 8AC1                  152                     MOV AL,CL
0076 BA8200                153                     MOV DX, PORTC   ;port C address to DX; 
0079 EE                    154                     OUT DX, AL      ;give positive logic to one of the rows
                           155                     
007A BA8100                156                     MOV DX, PORTB   ;port B address to DX  
007D EC                    157                     IN  AL,DX       ;read input port for key closure
                           158                     
                           159                     
                           160                     ;mov al,101b; change later
007E 2407                  161                     AND AL, 07H     ;Mask D4-D7
0080 3C07                  162                     CMP AL,07H
0082 742D                  163                     JE RETPOINT
                           164                     ;ERROR CHECK
0084 3C06                  165                     CMP AL,0110B
0086 740B                  166                     JE VALIDATED
0088 3C05                  167                     CMP AL,0101B
008A 7407                  168                     JE VALIDATED
008C 3C03                  169                     CMP AL,011B
008E 7403                  170                     JE VALIDATED
0090 EB1F90                171                     JMP RETPOINT
                           172                     
0093                       173     VALIDATED:              
0093 F6D0                  174                     NOT AL
0095 2407                  175                     AND AL, 07H; MASK OTHER BLOODY BITS OMGOMGOMG
0097 D0E8                  176                     SHR AL,01 ; DIVIDE AL BY 2. TO GET COL NUMBER
0099 8AD0                  177                     MOV DL,AL ; TEMP STORE AL IE PORTB INPUT AKA COL NUMBER
                           178                     
009B 8AC5                  179                     mov Al,CH ; ROW COUNT MOVED TO AL
009D B603                  180                     MOV DH,03 ; TO MULTIPLY BY 3
                           181                     ;MULTIPLY THE FUCKER
009F F6E6                  182                     MUL DH
                           183                     ; RESULT IN AX
                           184                     
                           185                     
                           186                     ; NUMBER  <= 9 
00A1 02C2                  187                     ADD AL, DL ;ADD row*3 NO TO COL NUMBER
00A3 8AD8                  188                     MOV BL,AL
00A5 32FF                  189                     XOR BH,BH
                           190                     ;Bl CONTAINS iNDEX OF ARRAY WITH CURRENT KEY
                           191                                                                     
00A7                       192     NUMBERS:
                           193                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    13:42:19  11/15/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

00A7 8A472D                194                     MOV AL,DS:array[BX] ; Stores character in AL (?)
00AA 32E4                  195                     XOR AH,AH
00AC 9A0000----     E      196                     CALL    FAR PTR PRINT_CHAR
                           197                     
                           198                             
00B1                       199     RETPOINT:       
00B1 FEC5                  200             INC CH
00B3 80FD04                201             CMP CH,04
00B6 75BA                  202             JNZ NXTROW
00B8 EBB4                  203             JMP INIT
                           204                     
                           205             
00BA 58                    206             POP AX
00BB 5B                    207             POP BX
00BC 59                    208             POP CX
00BD 5A                    209             POP DX
                           210     KEYBOARD ENDP
                           211     
00BE                       212     TIMER2_ACTION   PROC    FAR
00BE 50                    213                     PUSH    AX
00BF 1E                    214                     PUSH    DS
00C0 53                    215                     PUSH    BX
00C1 51                    216                     PUSH    CX
                           217     
00C2 B8----         R      218                     MOV     AX,DATA_SEG
00C5 8ED8                  219                     MOV     DS,AX
                           220             
00C7 FE0E1600              221                     DEC     DS:T_COUNT
00CB 7516                  222                     JNZ     T_NEXT1
00CD A01700                223                     MOV     AL,DS:T_COUNT_SET
00D0 A21600                224                     MOV     DS:T_COUNT,AL
                           225     
00D3 B91400                226                     MOV     CX,20
00D6 BB0000                227                     MOV     BX,0H
00D9                       228     T_NEXT0:
00D9 8A07                  229                     MOV     AL,DS:TIMER0_MESS[BX]
00DB 43                    230                     INC     BX
00DC 9A0000----     E      231                     CALL    FAR PTR PRINT_CHAR
00E1 E2F6                  232                     LOOP    T_NEXT0
                           233     
00E3 9A6A00----     R      234     T_NEXT1:        CALL FAR PTR KEYBOARD
00E8 59                    235                     POP     CX
00E9 5B                    236                     POP     BX
00EA 1F                    237                     POP     DS
00EB 58                    238                     POP     AX
00EC CB                    239                     RET
                           240     TIMER2_ACTION   ENDP
                           241     
                           242     
----                       243     CODE_SEG        ENDS
                           244     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
