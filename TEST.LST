8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    14:29:47  10/18/;2  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TEST.OBJ
ASSEMBLER INVOKED BY:  C:\USERS\A0074933\DOCUME~1\13\ASM86.EXE TEST.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     ; 1 KEYBOARD VERSION (TESTING ONLY)
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   set_timer2:far
  0080                      20     PORTA   equ 080h
  0081                      21     PORTB EQU 081H
  0082                      22     PORTC EQU 082H
  0083                      23     CWR EQU 083H
                            24     
----                        25     STACK_SEG       SEGMENT
0000 (256                   26                     DB      256 DUP(?)
     ??
     )
0100                        27             TOS     LABEL   WORD
----                        28     STACK_SEG       ENDS
                            29     
                            30     
----                        31     DATA_SEG        SEGMENT
                            32             
0000 0A                     33             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
0016 2F                     34             T_COUNT         DB      2FH
0017 2F                     35             T_COUNT_SET     DB      2FH
0018 0A                     36             REC_MESS        DB      10,13,'Period of timer0 = '  
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D20
002D 31                     37             array       DB      '1','2','3','4','5','6','7','8','9','*','0','#'     
002E 32
002F 33
0030 34
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    14:29:47  10/18/;2  PAGE    2


LOC  OBJ                  LINE     SOURCE

0031 35
0032 36
0033 37
0034 38
0035 39
0036 2A
0037 30
0038 23
                            38     
                            39     ;=========================================================================
                            40     ;Port B of the 8255 is used as the input port for the keybad
                            41     ;Port C is used as the output and grounds the rows one by one
                            42     ;=========================================================================
                            43     
----                        44     DATA_SEG        ENDS
                            45     
                            46     
----                        47     CODE_SEG        SEGMENT
                            48     
                            49             PUBLIC          START
                            50     
                            51     ASSUME  CS:CODE_SEG, SS:STACK_SEG, DS:DATA_SEG
                            52     
0000                        53     START:
                            54     ;initialize stack area
0000 B8----         R       55                     MOV     AX,STACK_SEG            
0003 8ED0                   56                     MOV     SS,AX
0005 368B260001             57                     MOV     SP,TOS
                            58     ;Initialise data segment
000A B8----         R       59                     MOV AX,DATA_SEG
000D 8ED8                   60                     MOV DS,AX
                            61     
                            62     ; Initialize the on-chip pheripherals
000F 9A0000----     E       63                     CALL FAR PTR IODEFINE
                            64                     
                            65     
                            66     
                            67     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                            68        
0014 B082                   69     MOV AL, 82H       ;mode 0, A - out, B-in ;changed value of CW from 82H
0016 BA8300                 70                     MOV DX, CWR
0019 EE                     71                     OUT DX, AL      ;send the control word
001A B300                   72                     MOV BL, 00H     ;initialize BL for key code
001C 33C0                   73                     XOR AX, AX      ;clear ax flags
001E BA8200                 74                     MOV DX, PORTC  ;port C address to DX
0021 EE                     75                     OUT DX, AL      ;ground all rows
                            76                     
                            77     
                            78     
                            79        
                            80     ;code
                            81      ;call set_timer2
0022 FB                     82                     STI
                            83     
0023                        84     NEXT: 
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    14:29:47  10/18/;2  PAGE    3


LOC  OBJ                  LINE     SOURCE

                            85     ;CALL FAR PTR KEYBOARD
0023 BB0100                 86                     mov bx, 01;
0026 8A472D                 87                     MOV AL,DS:array[BX] ; Stores character in AL (?)
0029 9A0000----     E       88                     call far ptr print_char
002E EBF3                   89      JMP NEXT
                            90     
                            91     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                            92     
                            93     
0030                        94     SERIAL_REC_ACTION       PROC    FAR
0030 51                     95                     PUSH    CX
0031 53                     96                     PUSH    BX
0032 1E                     97                     PUSH    DS
                            98     
0033 BB----         R       99                     MOV     BX,DATA_SEG             ;initialize data segment register
0036 8EDB                  100                     MOV     DS,BX
                           101     
0038 3C3C                  102                     CMP     AL,'<'
003A 750B                  103                     JNE     S_FAST
                           104     
003C FE061700              105                     INC     DS:T_COUNT_SET
0040 FE061700              106                     INC     DS:T_COUNT_SET
                           107     
0044 EB0D90                108                     JMP     S_NEXT0
0047                       109     S_FAST:
0047 3C3E                  110                     CMP     AL,'>'
0049 7521                  111                     JNE     S_RET
                           112     
004B FE0E1700              113                     DEC     DS:T_COUNT_SET
004F FE0E1700              114                     DEC     DS:T_COUNT_SET
                           115     
0053                       116     S_NEXT0:
0053 B91600                117                     MOV     CX,22                   ;initialize counter for message
0056 BB0000                118                     MOV     BX,0
                           119     
0059 8A4718                120     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
005C 9A0000----     E      121                     call    FAR ptr print_char
0061 43                    122                     INC     BX
0062 E2F5                  123                     LOOP    S_NEXT1
                           124     
0064 A01700                125                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
0067 9A0000----     E      126                     CALL    FAR PTR PRINT_2HEX
006C                       127     S_RET:
006C 1F                    128                     POP     DS
006D 5B                    129                     POP     BX
006E 59                    130                     POP     CX
006F CB                    131                     RET
                           132     SERIAL_REC_ACTION       ENDP
                           133     
0070                       134     KEYBOARD PROC FAR
                           135     
0070 52                    136                     PUSH    DX
0071 51                    137                     PUSH    CX
0072 53                    138                     PUSH    BX
0073 50                    139                     PUSH    AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    14:29:47  10/18/;2  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           140                     
                           141     
0074                       142     INIT:           
                           143                     
                           144                     
0074 B080                  145                     MOV AL, 80H     ;load data byte to ground a row;
0076 B300                  146                     MOV BL, 0H      ;set row counter
                           147                     
                           148     
                           149                     
0078                       150     NXTROW:         
0078 D0C0                  151                     ROL AL, 01H       ;rotate AL to ground next row/ al HAS 8 BITS. so mu
                                   st JMP BACK TO WAIT
007A 8AE8                  152                     MOV CH, AL      ;save data byte to ground next row ;WAT?
007C BA8200                153                     MOV DX, PORTC   ;port C address to DX; 
007F EE                    154                     OUT DX, AL      ;give positive logic to one of the rows
                           155                     
0080 BA8100                156                     MOV DX, PORTB   ;port B address to DX  
0083 EC                    157                     IN  AL,DX       ;read input port for key closure
0084 2407                  158                     AND AL, 07H     ;Mask D4-D7
0086 3C00                  159                     CMP AL,0H
0088 7410                  160                     JE RETPOINT
008A D0E8                  161                     SHR AL,01 ; DIVIDE AL BY 2. TO GET COL NUMBER
008C 02D8                  162                     ADD BL,AL ;ADD row NO TO COL NUMBER
008E 32FF                  163                     XOR BH,BH
                           164                     ;Bl CONTAINS iNDEX OF ARRAY WITH CURRENT KEY
                           165                                                                     
0090                       166     NUMBERS:
                           167                     
0090 8A472D                168                     MOV AL,DS:array[BX] ; Stores character in AL (?)
0093 32E4                  169                     XOR AH,AH
0095 9A0000----     E      170                     CALL    FAR PTR PRINT_CHAR
                           171                     
                           172                             
009A                       173     RETPOINT:       
009A FEC3                  174             INC BL
009C 80FB04                175             CMP BL,04
009F 75D7                  176             JNZ NXTROW
00A1 EBD1                  177             JMP INIT
                           178                     
                           179             
00A3 58                    180             POP AX
00A4 5B                    181             POP BX
00A5 59                    182             POP CX
00A6 5A                    183             POP DX
                           184     KEYBOARD ENDP
                           185     
00A7                       186     TIMER2_ACTION   PROC    FAR
00A7 50                    187                     PUSH    AX
00A8 1E                    188                     PUSH    DS
00A9 53                    189                     PUSH    BX
00AA 51                    190                     PUSH    CX
                           191     
00AB B8----         R      192                     MOV     AX,DATA_SEG
00AE 8ED8                  193                     MOV     DS,AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    14:29:47  10/18/;2  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           194             
00B0 FE0E1600              195                     DEC     DS:T_COUNT
00B4 7516                  196                     JNZ     T_NEXT1
00B6 A01700                197                     MOV     AL,DS:T_COUNT_SET
00B9 A21600                198                     MOV     DS:T_COUNT,AL
                           199     
00BC B91400                200                     MOV     CX,20
00BF BB0000                201                     MOV     BX,0H
00C2                       202     T_NEXT0:
00C2 8A07                  203                     MOV     AL,DS:TIMER0_MESS[BX]
00C4 43                    204                     INC     BX
00C5 9A0000----     E      205                     CALL    FAR PTR PRINT_CHAR
00CA E2F6                  206                     LOOP    T_NEXT0
                           207     
00CC 9A7000----     R      208     T_NEXT1:        CALL FAR PTR KEYBOARD
00D1 59                    209                     POP     CX
00D2 5B                    210                     POP     BX
00D3 1F                    211                     POP     DS
00D4 58                    212                     POP     AX
00D5 CB                    213                     RET
                           214     TIMER2_ACTION   ENDP
                           215     
                           216     
----                       217     CODE_SEG        ENDS
                           218     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
